import testMigrationsJson from "@rrrcn/common-helpers/src/test-configs/vulnerabilities/test-migrations.json";
import testAreaJson from "@rrrcn/common-helpers/src/test-configs/vulnerabilities/test-area.json";

import { Feature } from "@turf/turf";
import { MultiPolygon, Polygon } from "@turf/helpers";
import { habitatAreaOverallVulnerabilityController } from "@rrrcn/services/src/controllers/vulnerability/overall-vulnerability/habitat-area";
import { VulnerabilityResult } from "@rrrcn/common-types/strapi/models/VulnerabilityResult";
import { MigrationPath } from "@rrrcn/common-types/services/api/migrations/generate-tracks/config";
import { AnalysisResult } from "@rrrcn/common-types/strapi/models/AnalysisResult";
import { ServicesVulnerabilityApiTypes } from "@rrrcn/common-types/services/api/vulnerability";
const testArea = testAreaJson as unknown as Feature<Polygon | MultiPolygon>;
const testMigrations = [testMigrationsJson] as unknown as MigrationPath[];
const analysisConfig: ServicesVulnerabilityApiTypes.OverallHabitatAreaVulnerability.Body =
  {
    birds_count: 1000,
    // migrations: testMigrations,
    area: testArea,
    updownProportion: 0.5,
    yinc: 0.05,
    xinc: 0.05,

    windfarmInstanceConfig: {
      offset: 0,
      timeOfWorkPerMonth: [
        0.75, 0.8, 0.83, 0.76, 0.7, 0.67, 0.69, 0.7, 0.8, 0.83, 0.8, 0.78,
      ],
      hubheight: 90,
    },
    windfarmConfig: {
      pitch: 15,
      radius: 60.5,
      numberOfTurbines: 40,
      omega: 5,
      chord: 4.21,
      blades: 3,
      bladeForm: [
        [0.05, 0.73],
        [0.1, 0.79],
        [0.15, 0.88],
        [0.2, 0.96],
        [0.25, 1.0],
        [0.3, 0.98],
        [0.35, 0.92],
        [0.4, 0.85],
        [0.45, 0.8],
        [0.5, 0.75],
        [0.55, 0.7],
        [0.6, 0.64],
        [0.65, 0.58],
        [0.7, 0.52],
        [0.75, 0.47],
        [0.8, 0.41],
        [0.85, 0.37],
        [0.9, 0.3],
        [0.95, 0.24],
        [1, 0.0],
      ],
    },
    birdConfig: {
      nocturnalActivity: 0,
      speed: 5.06,
      flight_type: "gliding",
      length: 0.78,
      wingspan: 2.05,
    },
    outputs: "./test",

    percentAtRotorHeight: 0.18,
  };
let analysis_data: ServicesVulnerabilityApiTypes.OverallHabitatAreaVulnerability.Response;
let analysisResultEntity: AnalysisResult;
let vulnerabilityResults: VulnerabilityResult[];
let vulnerabilityResult: VulnerabilityResult;
beforeAll(async () => {
  analysis_data = await habitatAreaOverallVulnerabilityController(
    analysisConfig
  );
  analysisResultEntity = await strapi
    .service("api::analysis-result.analysis-result")
    .create({
      data: { analysis_data, analysis_type: "habitat-area-vulnerability" },
      populate: ["vulnerability_results", "vulnerability_results.habitat_area"],
    });
  vulnerabilityResults = await strapi.db
    .query("api::vulnerability-result.vulnerability-result")
    .findMany({
      where: {
        analysis_result: { id: analysisResultEntity.id },
      },
    });
  vulnerabilityResult = vulnerabilityResults[0];
});
describe("Vulnerability analysis result creates correctly", () => {
  test("Analysis result created", () => {
    expect(analysisResultEntity.id).toBeDefined();
  });

  test("Vulnerability result created", () => {
    expect(vulnerabilityResult).toBeDefined();
  });
  test("Vulnerability result created correct length", () => {
    expect(vulnerabilityResults).toHaveLength(1);
  });
  test("type correct", () =>
    expect(vulnerabilityResult.vulnerability_type).toBe("area"));
  test("raw data correct", () =>
    expect(vulnerabilityResult.data).toEqual(analysis_data));

  test("Area correct", () =>
    expect(vulnerabilityResult.polygon).toEqual(analysis_data.area));
  test("Vulnerability less than total birds count", () =>
    expect(vulnerabilityResult.vulnerability).toBeLessThanOrEqual(
      analysis_data.birds_count
    ));
  // test("Vulnerability result deleted after analysis result deleted", async () => {
  //   await strapi.entityService.delete(
  //     "api::analysis-result",
  //     analysisResultEntity.id
  //   ).delete;
  //   const vulnerabilityResultAfterDelete=await strapi.service("api::vulnerability-result.vulnerability-result")
  // });
});
