import { VulnerabilityResult } from "@rrrcn/common/dist/src/types/strapi/models/VulnerabilityResult";
import { Species } from "@rrrcn/common/dist/src/types/strapi/models/Species";
import { SpatialGridCell } from "@rrrcn/common/dist/src/types/strapi/models/SpatialGridCell";
import { calculateCellVulnerability } from "./calculate-cell-vulnerability";
export const mockSpecies: Species[] = [
  {
    id: 1,
    name: "Falco",
    createdAt: "2024-03-16T15:53:48.662Z",
    updatedAt: "2024-05-18T14:17:37.549Z",
    default_density_per_area_precense: null,
    locale: "en",
    slug: "falco",
    green_vulnerability_max: 2,
    yellow_vulnerability_max: 5,
    image: null,
    habitat_areas: null,
    createdBy: { id: 1, firstname: "admin", lastname: "admin", username: null },
    updatedBy: { id: 1, firstname: "admin", lastname: "admin", username: null },
    localizations: [
      {
        id: 4,
        name: "Орел",
        createdAt: "2024-05-18T14:17:37.504Z",
        updatedAt: "2024-05-18T14:17:37.504Z",
        default_density_per_area_precense: null,
        locale: "ru",
        slug: "falco",
        green_vulnerability_max: 2,
        yellow_vulnerability_max: 5,
      } as Species,
    ],
  },
  {
    id: 2,
    name: "Neophron",
    createdAt: "2024-03-16T15:54:00.597Z",
    updatedAt: "2024-05-18T14:08:22.413Z",
    default_density_per_area_precense: null,
    locale: "en",
    slug: "neophron",
    green_vulnerability_max: 3,
    yellow_vulnerability_max: 4,
    image: null,
    habitat_areas: null,
    createdBy: { id: 1, firstname: "admin", lastname: "admin", username: null },
    updatedBy: { id: 1, firstname: "admin", lastname: "admin", username: null },
    localizations: [
      {
        id: 3,
        name: "Стервятник",
        createdAt: "2024-05-18T14:08:22.366Z",
        updatedAt: "2024-05-18T14:08:22.366Z",
        default_density_per_area_precense: null,
        locale: "ru",
        slug: "neophron",
        green_vulnerability_max: 3,
        yellow_vulnerability_max: 4,
      } as Species,
    ],
  },
];
export const mockCell: SpatialGridCell = {
  polygon: {
    type: "Feature",
    properties: {},
    geometry: {
      coordinates: [
        [
          [69.7594441904005, 45.806146486622424],
          [69.7594441904005, 45.15286196690852],
          [70.5910708274316, 45.15286196690852],
          [70.5910708274316, 45.806146486622424],
          [69.7594441904005, 45.806146486622424],
        ],
      ],
      type: "Polygon",
    },
    id: 0,
  },
  species_infos: null,
  id: 0,
  vulnerability_infos: null,
  total_vulnerability: null,
  habitat_areas: null,
  sensitive_areas: null,
  bbox_bottom: null,
  bbox_left: null,
  bbox_right: null,
  bbox_top: null,
  createdAt: null,
  createdBy: null,
  publishedAt: null,
  spatial_grid: null,
  updatedAt: null,
  updatedBy: null,
  spatial_grid_district: null,
  results: null,
  species_cell_populations: null,
  vulnerability_results: null,
};
export const mockVulnerabilities: VulnerabilityResult[] = [
  {
    id: 0,
    vulnerability: 10,
    analysis_result: null,
    windfarm_data: null,
    bbox_bottom: null,
    bbox_right: null,
    bbox_left: null,
    bbox_top: null,
    createdAt: null,
    data: null,
    createdBy: null,
    polygon: {
      type: "Feature",
      properties: {},
      geometry: {
        coordinates: [
          [
            [70.153121738713, 45.80460492723023],
            [70.153121738713, 45.15286196690852],
            [70.5910708274316, 45.15286196690852],
            [70.5910708274316, 45.80460492723023],
            [70.153121738713, 45.80460492723023],
          ],
        ],
        type: "Polygon",
      },
    },
    dont_expires: null,
    habitat_area: null,
    publishedAt: null,
    spatial_grid: null,
    spatial_grid_cells: null,
    species: mockSpecies[0],
    updatedAt: null,
    vulnerability_type: null,
    updatedBy: null,
  },
  {
    id: 0,
    vulnerability: 10,
    analysis_result: null,
    windfarm_data: null,
    bbox_bottom: null,
    bbox_right: null,
    bbox_left: null,
    bbox_top: null,
    createdAt: null,
    data: null,
    createdBy: null,
    polygon: {
      type: "Feature",
      properties: {},
      geometry: {
        coordinates: [
          [
            [69.39336895903631, 45.79840194577528],
            [69.39336895903631, 45.15917954867609],
            [70.16203052071128, 45.15917954867609],
            [70.16203052071128, 45.79840194577528],
            [69.39336895903631, 45.79840194577528],
          ],
        ],
        type: "Polygon",
      },
    },
    dont_expires: null,
    habitat_area: null,
    publishedAt: null,
    spatial_grid: null,
    spatial_grid_cells: null,
    species: mockSpecies[1],
    updatedAt: null,
    vulnerability_type: null,
    updatedBy: null,
  },
];
test("Calculate total vulnerablity unit", () => {
  const vulnerability = calculateCellVulnerability(
    mockVulnerabilities,
    mockCell
  );
  // console.log(vulnerability);
  expect(vulnerability).toBeDefined();
  expect(vulnerability).toEqual(
    expect.objectContaining({
      total_vulnerability: expect.any(Number),
      speciesVulnerabilities: expect.objectContaining({
        "1": expect.objectContaining({
          species: expect.anything(),
          vulnerability: expect.any(Number),
        }),
        "2": expect.objectContaining({
          species: expect.anything(),
          vulnerability: expect.any(Number),
        }),
      }),
    })
  );
  expect(vulnerability.total_vulnerability).toBeCloseTo(15, 0);
  expect(vulnerability.speciesVulnerabilities["1"].vulnerability).toBeCloseTo(
    10,
    0
  );
  expect(vulnerability.speciesVulnerabilities["2"].vulnerability).toBeCloseTo(
    5,
    0
  );
});
